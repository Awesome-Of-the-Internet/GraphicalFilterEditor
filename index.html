<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
	<link rel="Shortcut Icon" href="/favicon.ico" />
	<title>Graphical Filter Editor (Test)</title>
	<style type="text/css">
		body {
			background-color: #000000;
			color: #ffffff;
			font: normal 16px sans-serif;
		}
		.NOTE {
			font-size: 13px;
			font-style: italic;
		}
		a {
			color: #3f3;
		}
		a:active, a:visited {
			color: #f33;
		}
	</style>
	<link rel="stylesheet" href="GraphicalFilterEditor.css" />
	<script type="text/javascript" charset="utf-8" src="Common.js"></script>
	<script type="text/javascript" charset="utf-8" src="FFTNR.js"></script>
	<script type="text/javascript" charset="utf-8" src="GraphicalFilterEditor.js"></script>
	<script type="text/javascript" charset="utf-8" src="GraphicalFilterEditorControl.js"></script>
	<script type="text/javascript" charset="utf-8" src="Analyzer.js"></script>
	<script type="text/javascript" charset="utf-8" src="AnalyzerWL.js"></script>
	<script type="text/javascript">
		//<![CDATA[
		"use strict";
		var audioContext, source, sourceAudio, graphicEqualizer, splitter, analyzer, analyzerType, merger;
		//fakeAudioContext was made only to act as a "null audio context", making at least the graph work in other browsers
		function fakeAudioContext() {
		}
		fakeAudioContext.prototype = {
			createChannelSplitter: function () {
				return {};
			},
			createChannelMerger: function () {
				return {};
			},
			createBuffer: function (channels, filterLength, sampleRate) {
				return {
					duration: filterLength / sampleRate,
					gain: 1,
					length: filterLength,
					numberOfChannels: channels,
					sampleRate: sampleRate,
					data: (function () {
						var a = new Array(channels), i;
						for (i = channels - 1; i >= 0; i--)
							a[i] = new Float32Array(filterLength);
						return a;
					})(),
					getChannelData: function (index) { return this.data[index]; }
				};
			},
			createConvolver: function () {
				var mthis = this;
				return {
					buffer: null,
					context: mthis,
					normalize: true,
					numberOfInputs: 1,
					numberOfOutputs: 1
				};
			}
		};
		function main() {
			attachMouse($("btnPlay"), "click", play);
			attachMouse($("btnStop"), "click", stop);
			$("txtFile").addEventListener("change", function () { $("chkSample").checked = false; return true; } );
			$("cbFilterLength").addEventListener("change", filterLengthChanged);
			$("cbAnalyzer").addEventListener("change", updateAnalyzer);
			//only the first 1024 samples are necessary as the last 1024 samples will always be zeroed out!
			audioContext = (window.AudioContext ? new AudioContext() : (window.webkitAudioContext ? new webkitAudioContext() : new fakeAudioContext()));
			graphicEqualizer = new GraphicalFilterEditorControl(2048, 44100, audioContext);
			graphicEqualizer.createControl($("equalizerPlaceholder"));
			analyzerType = null;
			analyzer = null;
			splitter = audioContext.createChannelSplitter();
			merger = audioContext.createChannelMerger();
			return true;
		}
		function cleanUpAnalyzer() {
			if (analyzer) {
				analyzer.stop();
				analyzer.destroyControl();
			}
			splitter.disconnect(0);
			splitter.disconnect(1);
			if (analyzer) {
				analyzer.analyzerL.disconnect(0);
				analyzer.analyzerR.disconnect(0);
				analyzerType = null;
				analyzer = null;
			}
			merger.disconnect(0);
			return true;
		}
		function stop() {
			if (source) {
				//sourceAudio.stop();
				//sourceAudio = null;
				source.noteOff(0);
				source.disconnect(0);
				source = null;
			}
			graphicEqualizer.filter.convolver.disconnect(0);
			return cleanUpAnalyzer();
		}
		function updateAnalyzer() {
			var t = $("cbAnalyzer").value;
			if (!source) return false;
			graphicEqualizer.filter.convolver.disconnect(0);
			switch (t) {
				case "fft":
				case "wl":
					if (analyzerType !== t) {
						if (analyzer) cleanUpAnalyzer();
						analyzerType = t;
						analyzer = ((analyzerType === "fft") ? new Analyzer(audioContext, graphicEqualizer.filter) : new AnalyzerWL(audioContext, graphicEqualizer.filter));
						analyzer.createControl($("analyzerPlaceholder"));
					}

					graphicEqualizer.filter.convolver.connect(splitter, 0, 0);
					splitter.connect(analyzer.analyzerL, 0, 0);
					splitter.connect(analyzer.analyzerR, 1, 0);

					analyzer.analyzerL.connect(merger, 0, 0);
					analyzer.analyzerR.connect(merger, 0, 1);

					merger.connect(audioContext.destination, 0, 0);
					return analyzer.start();
				default:
					graphicEqualizer.filter.convolver.connect(audioContext.destination, 0, 0);
					return cleanUpAnalyzer();
			}
		}
		function filterLengthChanged() {
			graphicEqualizer.changeFilterLength(parseInt($("cbFilterLength").value));
		}
		function play() {
			if ($("txtFile").files.length === 0 && !$("chkSample").checked) return false;

			stop();
			$("btnPlay").disabled = "disabled";
			graphicEqualizer.changeFilterLength(parseInt($("cbFilterLength").value));

			//currently media elements ignore connections :(
		
			//sourceAudio = document.createElement("audio");
			//sourceAudio.src = "test.mp3";
			//source = audioContext.createMediaElementSource(sourceAudio);
			try {
				var r;
				if ($("chkSample").checked) {
					r = new XMLHttpRequest();
					r.responseType = "arraybuffer";
					r.addEventListener("readystatechange", function () {
						if (r.readyState === 4) {
							try {
								source = audioContext.createBufferSource();
								source.buffer = audioContext.createBuffer(r.response, false);
								source.loop = true;

								//sourceAudio.load();

								source.connect(graphicEqualizer.filter.convolver, 0, 0);
								updateAnalyzer();

								//sourceAudio.play();
								source.noteOn(0);
							} catch (e) {
								alert(e);
							}
							$("btnPlay").disabled = "";
						}
					});
					r.open("GET", "midnightride.mp3", true);
					r.send();
				} else {
					r = new FileReader();
					r.addEventListener("load", function () {
						try {
							source = audioContext.createBufferSource();
							source.buffer = audioContext.createBuffer(r.result, false);
							source.loop = true;

							//sourceAudio.load();

							source.connect(graphicEqualizer.filter.convolver, 0, 0);
							updateAnalyzer();

							//sourceAudio.play();
							source.noteOn(0);
						} catch (e) {
							alert(e);
						}
						$("btnPlay").disabled = "";
					});
					r.readAsArrayBuffer($("txtFile").files[0]);
				}
			} catch (e) {
				$("btnPlay").disabled = "";
				alert(e);
			}

			return true;
		}
		//]]>
	</script>
</head>
<body>
<div style="margin: 16px 0px;"><div style="display: inline-block; background-color: #303030; padding: 8px;">
<label for="txtFile">Load your own file:</label> <input type="file" id="txtFile" /><br />
or<br />
<input type="checkbox" id="chkSample" checked="checked" /><label for="chkSample">Try this sample: 50 seconds from the free track Midnight Ride, created by SoundJay</label> - <a href="http://www.soundjay.com">www.soundjay.com</a><br />
<div style="margin-top: 8px; border-top: 1px solid #fff; padding-top: 8px;"></div>
<button id="btnPlay">Play</button>
<button id="btnStop">Stop</button>
<div style="margin-top: 8px; border-top: 1px solid #fff; padding-top: 8px;"><label for="cbFilterLength">Filter Length:</label> <select id="cbFilterLength">
	<option value="256">256</option>
	<option value="512">512</option>
	<option value="1024">1024</option>
	<option value="2048" selected="selected">2048</option>
</select> <label for="cbAnalyzer">Analyzer:</label> <select id="cbAnalyzer">
	<option value="none" selected="selected">None</option>
	<option value="fft">Frequency analyzer</option>
	<option value="wl">Haar wavelet analyzer</option>
</select><br /><span class="NOTE">Check out the functions main() and updateAnalyzer() to see how to have stereo output using two analyzers!</span></div></div></div>

<div id="equalizerPlaceholder"></div>
<div id="analyzerPlaceholder" style="vertical-align: top; display: inline-block;"></div>

<p class="NOTE">This is a test for a JavaScript graphical filter editor, created by me
(Carlos Rafael Gimenes das Neves - <a href="http://twitter.com/carlosrafaelgn">@carlosrafaelgn</a>,
<script type="text/javascript">//<![CDATA[
	"use strict";
	document.write(["c", "a", "r", "l", "o", "s", "r", "a", "f", "a", "e", "l", ".", "prog"].join(""));
	document.write(" at ");
	document.write([" ", "g", "m", "a", "il", " dot "].join(""));
	document.write(["c", "o", "m"].join(""));
	//]]></script>), based on my old C++ graphic equalizer.<br />Check out the <a href="https://github.com/carlosrafaelgn/GraphicalFilterEditor">source</a> for more information! This test uses the new <a href="http://www.w3.org/TR/webaudio/">Web Audio API</a> and requires the latest version of Chrome.</p>
<p class="NOTE">If running this locally, Chrome must be started with the command-line option --allow-file-access-from-files otherwise you will not be able to load any files!</p>

<script type="text/javascript">//<![CDATA[
"use strict"; main(); //]]></script>
</body>
</html>
